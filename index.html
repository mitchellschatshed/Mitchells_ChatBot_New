<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Mitchells Chat Shed</title>
  <link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville&family=Pluto+Sans:wght@400;700&display=swap" rel="stylesheet">
  <style>
    /* MAIN OUTER CONTAINER */
    body {
      margin: 0;
      background: #F6EBE4;
      font-family: 'Pluto Sans', sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }

    /* OUTER CARD CONTAINER */
    .chat-wrapper {
      position: relative;
      width: 400px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
    }

    /* CORNER ICON (farm image outside corner) */
    .corner-icon {
      position: absolute;
      top: 20px;
      left: -40px;
      width: 90px;
      border-radius: 20px;  
      object-fit: contain;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      background: white;
      border: 2px solid white;
      z-index: 2;
    }

    /* HEADER */
    .chat-header {
      background: #008554;
      color: white;
      text-align: center;
      padding: 20px;
      border-top-left-radius: 12px;
      border-top-right-radius: 12px;
      font-family: 'Pluto Sans', sans-serif;
      font-size: 22px;
      position: relative;
    }

    /* HEADER IMAGE */
    .chat-header img {
      position: absolute;
      top: 10px;
      left: 10px;
      width: 40px;
      border-radius: 6px;
    }

    /* OUTER MESSAGE CONTAINER */
    .chat-messages {
      padding: 15px;
      border-bottom: 1px solid #ddd;
    }

    /* MESSAGE DISPLAY BOX */
    .message-container {
      background: #f2f2f2;
      border: 1px solid #ccc;
      border-radius: 8px;
      height: 300px;
      overflow-y: auto;
      padding: 15px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    /* INDIVIDUAL MESSAGE BUBBLES */
    .message {
      display: inline-block;
      max-width: 80%;
      margin-bottom: 12px;
      padding: 5px 14px;
      border-radius: 18px;
      font-size: 12px;
      line-height: 1.4;
      word-wrap: break-word;
      white-space: pre-wrap;
      clear: both;
    }

    /* BOT MESSAGE BUBBLE */
    .bot {
      background: #e0e0e0;
      color: black;
      text-align: left;
      margin-right: auto;
    }

    /* USER MESSAGE BUBBLE */
    .user {
      background: #68c187;
      color: white;
      text-align: right;
      margin-left: auto;
    }

    /* INPUT CONTAINER */
    .chat-input {
      padding: 15px;
      border-top: 1px solid #ddd;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    /* TEXTAREA */
    .chat-input textarea {
      resize: none;
      height: 50px;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 10px;
      font-family: inherit;
      font-size: 12px;
    }

    /* SEND BUTTON */
    .chat-input button {
      background: #68c187;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 10px 16px;
      font-family: 'Pluto Sans', sans-serif;
      cursor: pointer;
      width: 100%;
    }

    /* SEND BUTTON HOVER */
    .chat-input button:hover {
      background: #008554;
    }
  </style>
</head>
<body>
  <div class="chat-wrapper">
    <img class="corner-icon" src="https://raw.githubusercontent.com/mitchellschatshed/Mitchells_ChatBot_New/master/images/farm2.png" alt="Farm icon">
    <div class="chat-header">Mitchells Chat Shed</div>

    <!-- MESSAGE CONTAINER -->
    <div class="chat-messages">
      <div class="message-container" id="response"></div>
    </div>

    <!-- INPUT CONTAINER -->
    <div class="chat-input">
      <textarea id="message" rows="2" placeholder="Type your message..."></textarea>
      <button onclick="sendMessage()">Send</button>
    </div>
  </div>

  <script>
   let conversation = [
  { role: "system", content: `
    You are a chatbot focused entirely on mental wellbeing for UK farmers. Your role is to listen, offer empathy, and help the user feel heard. Speak in a warm, understanding, and supportive tone. Don't repeat questions like "How are you feeling today?" unless absolutely necessary. 
    Focus on continuing the conversation, acknowledging their feelings, and asking open-ended questions based on what they say. Respond empathetically to their struggles, offering reassurance that they are not alone in this.
    Don't focus on facts or giving advice unless explicitly asked. Instead, offer a safe space for them to express their feelings and struggles.
    You dont always have to write a set amount words, just be human like. It should feel as though your talking to a neigbour while lent over the farm gate chatting about humans issues but just focus on the person with the issues. 
  ` }
];

const inputBox = document.getElementById('message');
inputBox.addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
});

async function sendMessage() {
  const msg = inputBox.value.trim();
  if (!msg) return;
  const responseDiv = document.getElementById('response');
  responseDiv.innerHTML += `<div class='message user'>${msg}</div>`;
  inputBox.value = '';
  responseDiv.scrollTop = responseDiv.scrollHeight;

  // Append the user's message to the conversation
  conversation.push({ role: 'user', content: msg });

  try {
    const res = await fetch('https://the-mitchells-chat-shed.onrender.com/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ messages: conversation }) // Send the entire conversation history
    });
    const data = await res.json();
    
    // Bot responds based on the user input
    let botReply = data.reply || "I’m here to listen. Would you like to tell me more about what’s been going on?";

    // Personalize the response based on the user's input (no repeating the same questions)
    if (msg.toLowerCase().includes("stress") || msg.toLowerCase().includes("overwhelmed")) {
      botReply = `I hear you, that sounds tough. It’s understandable to feel overwhelmed with everything going on. Do you want to talk about what’s been the biggest stress for you lately?`;
    }
    if (msg.toLowerCase().includes("lonely")) {
      botReply = `I’m really sorry you’re feeling lonely. Farming can feel isolating sometimes, but you’re not alone. Would you like to talk about how it’s been affecting you?`;
    }

    responseDiv.innerHTML += `<div class='message bot'>${botReply}</div>`;
    responseDiv.scrollTop = responseDiv.scrollHeight;

    // Append the bot's reply to the conversation for the next interaction
    conversation.push({ role: 'assistant', content: botReply });

  } catch (err) {
    responseDiv.innerHTML += `<div class='message bot' style='color:red;'>Error getting reply</div>`;
    responseDiv.scrollTop = responseDiv.scrollHeight;
  }
}
  </script>
</body>
</html>
